<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bird Counter</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"
        integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+"
        crossorigin="anonymous"></script>
    <style>
        canvas {
            border: 1px solid #000;
            max-width: 100%;
        }
    </style>
</head>

<body>
    <canvas id="canvas"></canvas>
    <script>
        const socket = io("http://192.168.178.135:3000");
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // FPS calculation variables
        let frameCount = 0;
        let lastTime = performance.now();
        let fps = 0;
        const fpsUpdateInterval = 500; // Update FPS every 500ms

        // Set canvas size to match window size
        function resizeCanvas() {
            canvas.width = window.innerWidth * 0.8;
            canvas.height = window.innerHeight * 0.8;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('bird_update', (data) => {
            frameCount++;
            const currentTime = performance.now();
            if (currentTime - lastTime >= fpsUpdateInterval) {
                fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                frameCount = 0;
                lastTime = currentTime;
            }

            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const aspectRatio = img.width / img.height;
                let drawWidth = canvas.width;
                let drawHeight = canvas.width / aspectRatio;

                if (drawHeight > canvas.height) {
                    drawHeight = canvas.height;
                    drawWidth = canvas.height * aspectRatio;
                }

                const x = (canvas.width - drawWidth) / 2;
                const y = (canvas.height - drawHeight) / 2;

                ctx.drawImage(img, x, y, drawWidth, drawHeight);
                ctx.fillStyle = 'white';
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 3;
                ctx.font = '24px Arial';

                const countText = `Count: ${data.count}`;
                const timestampText = data.timestamp;
                const fpsText = `FPS: ${fps}`;

                ctx.strokeText(countText, 20, 40);
                ctx.fillText(countText, 20, 40);

                ctx.strokeText(timestampText, 20, 70);
                ctx.fillText(timestampText, 20, 70);

                ctx.strokeText(fpsText, 20, 100);
                ctx.fillText(fpsText, 20, 100);
            };

            // Set the image source directly from the base64 data
            img.src = 'data:image/jpeg;base64,' + data.image;
        });
    </script>
</body>

</html>